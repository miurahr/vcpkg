# Appveyor CI configuration for vcpkg project.
#
# Copyright 2018 Hiroshi Miura
#
image: Visual Studio 2017
shallow_clone: false

environment:
  APPVEYOR_SAVE_CACHE_ON_ERROR: true
  VCPKG_FEATURE_FLAGS: "binarycaching"
  matrix:
    - VCPKG_DEFAULT_TRIPLET: x86-windows
    - VCPKG_DEFAULT_TRIPLET: x86-windows-static
    - VCPKG_DEFAULT_TRIPLET: x64-windows
    - VCPKG_DEFAULT_TRIPLET: x64-windows-static
    - VCPKG_DEFAULT_TRIPLET: arm-uwp

cache:
  - archives

install:
  - ps: |
      ./scripts/bootstrap.ps1
      # Detect modified ports and make changes list
      # fetch upstream project which is necessary for forked project to compare with.
      git remote add upstream https://github.com/Microsoft/vcpkg.git
      git fetch -q upstream
      $targets = git diff --name-only upstream/master... |
          ?{$_ -match "ports/(?<change>.*?)/"} | %{$Matches.change} | Group-Object | % Name
      if([string]::IsNullOrWhitespace($targets)) { $targets = "zlib" }
      ./vcpkg.exe remove  $targets --recurse
      ./vcpkg.exe install $targets --recurse --keep-going --binarycaching
      ./vcpkg.exe export $targets --zip
      $targets.Split(" ") | %{ 7z a $_-buildlog.7z buildtrees\$_\*.log }

build: off
test: off
deploy: off

artifacts:
  - path: '*.zip'
  - path: '*.7z'
